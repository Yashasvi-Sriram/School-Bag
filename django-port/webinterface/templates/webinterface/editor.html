{% extends 'webinterface/base.html' %}
{% block title %}Editor{% endblock %}
{% block css %}
    <style>
        #editor {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            margin: 0;
            z-index: 101;
            padding: 50px 20px 50px 20px;
            font-family: 'Ubuntu Mono', monospace;
            background-color: #222222;
            color: white;
            font-size: 20px;
            font-weight: bold;
            display: none;
        }

        #editor #text {
            font-size: 20px;
            font-weight: bold;
            border: 2px dashed cyan;
            width: 100%;
            height: 100%;
            margin: 0;
            box-shadow: none;
        }

        #editor #text:focus {
            outline: none;
        }

        #editor #book-name {
            position: absolute;
            top: 0;
            right: 0;
            padding: 20px;
            font-size: 20px;
            font-weight: bold;
            color: cyan;
        }

        #editor #page-name {
            position: absolute;
            top: 0;
            left: 0;
            padding: 20px;
            font-size: 20px;
            font-weight: bold;
            color: red;
        }

        #editor #password-input {
            position: absolute;
            width: 50vw;
            top: 0;
            left: 25vw;
            margin: 0;
            background-color: transparent;
            color: cyan;
            font-size: 20px;
            font-weight: bold;
            border-left: 2px dashed red;
            border-right: 2px dashed red;
            border-top: 2px dashed red;
            border-bottom: none;
            box-shadow: none;
            display: none;
        }
    </style>
{% endblock %}
{% load static %}
{% block body %}
    <script src="{% static 'webinterface/cli/editor.js' %}"></script>
    <script src="{% static 'webinterface/cli/multikeycallbackmanager.js' %}"></script>
    <div id="editor">
        <div id="book-name">Book</div>
        <div id="page-name">Page</div>
        <textarea id="text"></textarea>
        <input id="password-input" type="password">
        <div>Exit: Ctrl + q | Save: Ctrl + s</div>
    </div>
    <script>
        $(document).ready(function () {
            var tree = [
                {
                    code: 17,
                    action: [
                        {
                            code: 81,
                            // Ctrl + Q => close editor
                            action: function (e) {
                                e.preventDefault();
                                Editor.close();
                            }
                        },
                        {
                            code: 83,
                            // Ctrl + S => save editor content
                            action: function (e) {
                                e.preventDefault();
                                Editor._save();
                            }
                        }
                    ]
                }
            ];
            MultiKeyCallBackManager.bind(tree);
            MultiKeyCallBackManager.init();

            Editor.bind('editor', 'book-name', 'page-name', 'text');
            Editor.oSave = function () {
                $.ajax({
                    url: "{% url 'restapi:page_update_text' %}",
                    method: 'POST',
                    data: {
                        book_name: Editor._currentBookName,
                        page_name: Editor._currentPageName,
                        text: $(Editor._textareaHId).val()
                    },
                    success: function (response) {
                        var jsonedResponse = JSON.parse(response);
                        if (jsonedResponse.status === 0) {
                            Materialize.toast('Saved', 2000);
                        } else if (jsonedResponse.status === -1) {
                            Materialize.toast(jsonedResponse.message, 2000);
                        }
                    },
                    error: function (response) {
                        Materialize.toast('Server Error', 2000);
                    },
                    beforeSend: function (xhr, settings) {
                        if (!(/^(GET|HEAD|OPTIONS|TRACE)$/.test(settings.type)) && !this.crossDomain) {
                            xhr.setRequestHeader("X-CSRFToken", Cookies.get('csrftoken'));
                        }
                    }
                });
            }
        });
    </script>
{% endblock %}