{% extends 'webinterface/base.html' %}
{% block title %}CLI{% endblock %}
{% block css %}
    <style>
        #terminal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            margin: 0;
            z-index: 100;
            padding: 20px;
            font-family: 'Ubuntu Mono', monospace;
            background-color: black;
            color: #64dd17;
            font-size: 20px;
            font-weight: bold;
        }

        #terminal #prefix {
            height: 100%;
        }

        #terminal #cmd {
            font-size: 20px;
            font-weight: bold;
            border: none;
            margin: 0;
            width: 70%;
            box-shadow: none;
        }

        #editor {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            margin: 0;
            z-index: 101;
            padding: 50px 20px 50px 20px;
            font-family: 'Ubuntu Mono', monospace;
            background-color: #222222;
            color: white;
            font-size: 20px;
            font-weight: bold;
            display: none;
        }

        #editor #text {
            font-size: 20px;
            font-weight: bold;
            border: 2px dashed cyan;
            width: 100%;
            height: 100%;
            margin: 0;
            box-shadow: none;
        }

        #editor #text:focus {
            outline: none;
        }

        #editor #book-name {
            position: absolute;
            top: 0;
            right: 0;
            padding: 20px;
            font-size: 20px;
            font-weight: bold;
            color: cyan;
        }

        #editor #page-name {
            position: absolute;
            top: 0;
            left: 0;
            padding: 20px;
            font-size: 20px;
            font-weight: bold;
            color: red;
        }

        #editor #password-input {
            position: absolute;
            width: 50vw;
            top: 0;
            left: 25vw;
            margin: 0;
            background-color: transparent;
            color: cyan;
            font-size: 20px;
            font-weight: bold;
            border-left: 2px dashed red;
            border-right: 2px dashed red;
            border-top: 2px dashed red;
            border-bottom: none;
            box-shadow: none;
            display: none;
        }
    </style>
{% endblock %}
{% load static %}
{% block body %}
    <script src="{% static 'webinterface/cli/yash.js' %}"></script>
    <script src="{% static 'webinterface/cli/multikeycallbackmanager.js' %}"></script>
    <script>
        /**
         * when book is selected book is set to that book's name
         * no book selected => book is ''
         * */
        var Context = {
            _book: '',
            getPrefix: function () {
                return '$[/schoolbag/' + this._book + ']: '
            },
            _setBook: function (book) {
                if (book === undefined) {
                    this._book = '';
                    yaSH.setPrefix(this.getPrefix());
                } else {
                    this._book = book;
                    yaSH.setPrefix(this.getPrefix());
                }
            },
        };

        // colors
        yaSH.Config.color.book = 'blue';
        yaSH.Config.color.page = 'green';
        yaSH.setPrefix(Context.getPrefix());

        // about
        yaSH.addCmd({
            keywords: ["about", "whatisthis"],
            desc: "brief description about school bag",
            exec: function (tokens) {
                yaSH.printPre('School Bag is a place where you keep all your knowledge', 'gold');
            }
        });
        // cd
        yaSH.addCmd({
            keywords: ["cd"],
            desc: "select or deselect a book. Usage cd {book name} or cd ..",
            exec: function (tokens) {
                if (tokens.length < 2) {
                    yaSH.printErr('usage: cd {book name} or cd ..');
                    return;
                }
                var book = tokens.splice(1).join(' ');
                if (book === '..') {
                    Context._setBook();
                } else {
                    $.ajax({
                        url: "{% url 'restapi:book_exists' %}",
                        method: 'GET',
                        data: {
                            book_name: book
                        },
                        success: function (response) {
                            var jsonedResponse = JSON.parse(response);
                            if (jsonedResponse.status === 0) {
                                Context._setBook(book);
                            } else if (jsonedResponse.status === -1) {
                                yaSH.printErr(jsonedResponse.message, 2000);
                            }
                        },
                        error: function (response) {
                            yaSH.printErr('Server Error', 2000);
                        }
                    });
                }
            }
        });
        // ls
        yaSH.addCmd({
            keywords: ["ls"],
            desc: "list all in current working place",
            exec: function (tokens) {
                $.ajax({
                    url: "{% url 'restapi:ls' %}",
                    method: 'GET',
                    data: {
                        book_name: Context._book
                    },
                    success: function (response) {
                        var jsonedResponse = JSON.parse(response);
                        if (jsonedResponse.status === 0) {
                            yaSH.print('------');
                            yaSH.print('@book', yaSH.Config.color.book);
                            yaSH.print('------');
                            yaSH.print('@page', yaSH.Config.color.page);
                            yaSH.print('------');
                            yaSH.println('');
                            var books = jsonedResponse.body.books;
                            var pages = jsonedResponse.body.pages;
                            for (var i = 0; i < books.length; ++i)
                                yaSH.println(books[i], yaSH.Config.color.book);
                            for (i = 0; i < pages.length; ++i)
                                yaSH.println(pages[i], yaSH.Config.color.page);
                        } else if (jsonedResponse.status === -1) {
                            yaSH.printErr(jsonedResponse.message, 2000);
                        }
                    },
                    error: function (response) {
                        yaSH.printErr('Server Error', 2000);
                    }
                });
            }
        });
        // pwd
        yaSH.addCmd({
            keywords: ["pwd"],
            desc: "prints current working place",
            exec: function (tokens) {
                if (Context._book === '') {
                    yaSH.println('/schoolbag/', 'lightblue');
                } else {
                    yaSH.println('/schoolbag/' + Context._book, 'lightblue');
                }
            }
        });
        // mkb <book name>
        yaSH.addCmd({
            keywords: ["mkb"],
            desc: "creates new a book. usage mkb {book name}",
            exec: function (tokens) {
                if (tokens.length < 2) {
                    yaSH.printErr('usage: mkb {book name}');
                    return;
                }
                if (Context._book !== '') {
                    yaSH.printErr('cannot create book in another book');
                    yaSH.println('you may want to create a book in schoolbag');
                    return;
                }
                var book = tokens.splice(1).join(' ');
                $.ajax({
                    url: "{% url 'restapi:book_create' %}",
                    method: 'POST',
                    data: {
                        book_name: book
                    },
                    success: function (response) {
                        var jsonedResponse = JSON.parse(response);
                        if (jsonedResponse.status === 0) {
                        } else if (jsonedResponse.status === -1) {
                            yaSH.printErr(jsonedResponse.message);
                        }
                    },
                    error: function (response) {
                        yaSH.printErr('Server Error');
                    },
                    beforeSend: function (xhr, settings) {
                        if (!(/^(GET|HEAD|OPTIONS|TRACE)$/.test(settings.type)) && !this.crossDomain) {
                            xhr.setRequestHeader("X-CSRFToken", Cookies.get('csrftoken'));
                        }
                    }
                });
            }
        });
        // mkp <page name>
        yaSH.addCmd({
            keywords: ["mkp"],
            desc: "creates new a page. usage mkp {page name}",
            exec: function (tokens) {
                if (tokens.length < 2) {
                    yaSH.printErr('usage: mkp {page name}');
                    return;
                }
                var page = tokens.splice(1).join(' ');
                $.ajax({
                    url: "{% url 'restapi:page_create' %}",
                    method: 'POST',
                    data: {
                        book_name: Context._book,
                        page_name: page
                    },
                    success: function (response) {
                        var jsonedResponse = JSON.parse(response);
                        if (jsonedResponse.status === 0) {
                        } else if (jsonedResponse.status === -1) {
                            yaSH.printErr(jsonedResponse.message);
                        }
                    },
                    error: function (response) {
                        yaSH.printErr('Server Error');
                    },
                    beforeSend: function (xhr, settings) {
                        if (!(/^(GET|HEAD|OPTIONS|TRACE)$/.test(settings.type)) && !this.crossDomain) {
                            xhr.setRequestHeader("X-CSRFToken", Cookies.get('csrftoken'));
                        }
                    }
                });
            }
        });
        // rmb <book name>
        yaSH.addCmd({
            keywords: ["rmb"],
            desc: "deletes specified book. usage rmb {book name}",
            exec: function (tokens) {
                if (tokens.length < 2) {
                    yaSH.printErr('usage: rmb {book name}');
                    return;
                }
                var book = tokens.splice(1).join(' ');
                $.ajax({
                    url: "{% url 'restapi:book_delete' %}",
                    method: 'POST',
                    data: {
                        book_name: book
                    },
                    success: function (response) {
                        var jsonedResponse = JSON.parse(response);
                        if (jsonedResponse.status === 0) {
                        } else if (jsonedResponse.status === -1) {
                            yaSH.printErr(jsonedResponse.message);
                        }
                    },
                    error: function (response) {
                        yaSH.printErr('Server Error');
                    },
                    beforeSend: function (xhr, settings) {
                        if (!(/^(GET|HEAD|OPTIONS|TRACE)$/.test(settings.type)) && !this.crossDomain) {
                            xhr.setRequestHeader("X-CSRFToken", Cookies.get('csrftoken'));
                        }
                    }
                });
            }
        });
        // rmp <page name>
        yaSH.addCmd({
            keywords: ["rmp"],
            desc: "deletes specified page in current book or schoolbag. usage rmp {page name}",
            exec: function (tokens) {
                if (tokens.length < 2) {
                    yaSH.printErr('usage: rmp {page name}');
                    return;
                }
                var page = tokens.splice(1).join(' ');
                $.ajax({
                    url: "{% url 'restapi:page_delete' %}",
                    method: 'POST',
                    data: {
                        book_name: Context._book,
                        page_name: page
                    },
                    success: function (response) {
                        var jsonedResponse = JSON.parse(response);
                        if (jsonedResponse.status === 0) {
                        } else if (jsonedResponse.status === -1) {
                            yaSH.printErr(jsonedResponse.message);
                        }
                    },
                    error: function (response) {
                        yaSH.printErr('Server Error');
                    },
                    beforeSend: function (xhr, settings) {
                        if (!(/^(GET|HEAD|OPTIONS|TRACE)$/.test(settings.type)) && !this.crossDomain) {
                            xhr.setRequestHeader("X-CSRFToken", Cookies.get('csrftoken'));
                        }
                    }
                });
            }
        });
        // nano <page name>
        yaSH.addCmd({
            keywords: ["nano"],
            desc: "opens page in current book or schoolbag in read mode. usage nano {page name}",
            exec: function (tokens) {
                if (tokens.length < 2) {
                    yaSH.printErr('nano {page name}');
                    return;
                }
                var page = tokens.splice(1).join(' ');
                $.ajax({
                    url: "{% url 'restapi:page_read_text' %}",
                    method: 'POST',
                    data: {
                        book_name: Context._book,
                        page_name: page
                    },
                    success: function (response) {
                        var jsonedResponse = JSON.parse(response);
                        if (jsonedResponse.status === 0) {
                            Editor.open(Context._book, page, jsonedResponse.body);
                        } else if (jsonedResponse.status === -1) {
                            yaSH.printErr(jsonedResponse.message);
                        }
                    },
                    error: function (response) {
                        yaSH.printErr('Server Error');
                    },
                    beforeSend: function (xhr, settings) {
                        if (!(/^(GET|HEAD|OPTIONS|TRACE)$/.test(settings.type)) && !this.crossDomain) {
                            xhr.setRequestHeader("X-CSRFToken", Cookies.get('csrftoken'));
                        }
                    }
                });
            }
        });
        // mvb
        // mvc
        // cat <page name>

    </script>
    <div id="terminal">
        <div id="log"></div>
        <span id="prefix">$: </span><input id="cmd" autofocus>
    </div>
    <script>
        var Editor = {
            _containerDivHId: undefined,
            _bookNameInputHId: undefined,
            _pageNameInputHId: undefined,
            _textareaHId: undefined,
            _inReadMode: true,
            _currentBookName: undefined,
            _currentPageName: undefined,
            bind: function (containerId, bookNameInputId, pageNameInputId, textareaId) {
                this._containerDivHId = '#' + containerId;
                this._bookNameInputHId = '#' + bookNameInputId;
                this._pageNameInputHId = '#' + pageNameInputId;
                this._textareaHId = '#' + textareaId;
            },
            open: function (book, page, text, inReadMode) {
                if (book === undefined ||
                    page === undefined ||
                    text === undefined)
                    return;

                inReadMode = inReadMode === undefined ? true : inReadMode;
                this._currentBookName = book;
                $(this._bookNameInputHId).html(book);
                this._currentPageName = page;
                $(this._pageNameInputHId).html(page);
                $(this._textareaHId).val(text);

                this._inReadMode = inReadMode;
                if (this._inReadMode) {
                    $(this._textareaHId).prop('readonly', true);
                }
                else {
                    $(this._textareaHId).prop('readonly', false);
                    $(this._textareaHId).focus();
                }

                $(this._containerDivHId).show();
            },
            close: function () {
                $(this._containerDivHId).hide();
            }
        };
    </script>
    <div id="editor">
        <div id="book-name">Book</div>
        <div id="page-name">Page</div>
        <textarea id="text"></textarea>
        <input id="password-input" type="password">
    </div>
    <script>
        $(document).ready(function () {
            var tree = [
                {
                    code: 17,
                    action: [
                        {
                            code: 76,
                            action: function (e) {
                                e.preventDefault();
                                yaSH.evaluate('clear');
                            }
                        },
                        {
                            code: 72,
                            action: function (e) {
                                e.preventDefault();
                                yaSH.evaluate('help');
                            }
                        },
                        {
                            code: 88,
                            action: function (e) {
                                e.preventDefault();
                                Editor.close();
                            }
                        }
                    ]
                }
            ];
            MultiKeyCallBackManager.bind(tree);
            MultiKeyCallBackManager.init();

            yaSH.bind('cmd', 'log', 'terminal', 'prefix');
            yaSH.initShell();

            Editor.bind('editor', 'book-name', 'page-name', 'text');
        });
    </script>
{% endblock %}